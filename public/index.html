<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Andy's 3D Battleship</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
    <script>
        const socket = io({
            path: '/socket.io/',
            transports: ['websocket', 'polling'],
            secure: true
        });

        socket.on('connect', () => {
            alert('Connected');
            console.log('Connected');
        });
        if (localStorage.getItem('userId') === null) {
            localStorage.setItem('userId', crypto.randomUUID());
        }

        function createRoom() {
            const userId = localStorage.getItem('userId');
            console.log("Emitting");
            socket.emit('createRoom', userId, (response) => {
                alert(response.room);
                if (response.success) {
                    localStorage.setItem('roomId', response.room);
                    document.getElementById('createdRoomId').textContent = response.room;
                    // TODO show a modal telling user they're waiting for someone to join
                } else {
                    // TODO fancier bootstrap stuff
                    alert("Room could not be created.");
                }
            });
        }

        function enterRoom(event) {
            const userId = localStorage.getItem('userId');
            event.preventDefault();
            const roomId = document.getElementById('roomId').value;
            if (!roomId) {
                // Show some kind of error popup
            }

            socket.emit('joinRoom', userId, roomId, (response) => {});
        }

        function cancelRoom() {
            const roomId = localStorage.getItem('roomId');
            if (!roomId) {
                return;
            }

            socket.emit('cancelRoom', (roomId));
            localStorage.removeItem('roomId');
        }

        socket.on('startPlacing', (response) => {
            localStorage.setItem('roomId', response.roomId);
            window.location.replace('/game/placeships');
        });
    </script>
</head>

<body>
  <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#joinModal">
     Join Room
  </button>
  <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#createModal" onclick="createRoom()">Create Room</button>

  <!--  Create Room Modal-->
  <div class="modal fade" id="createModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title">Room created!</h5>
              </div>
              <div class="modal-body">
                  <p class="modal-content" id="createdRoomId">Your room code is: </p>
                  <p>Waiting for other user to join..</p>
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="cancelRoom()">Cancel</button>
              </div>
          </div>
      </div>
  </div>

  <!-- Join Room Modal -->
  <div class="modal fade" id="joinModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title">Enter room code</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <form class="modal-body" onsubmit="enterRoom(event)">
                  <input class="form-control" type="text" name="roomId" id="roomId" placeholder="Room ID">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                  <input class="btn btn-primary" type="submit">
              </form>
          </div>
      </div>
  </div>
</body>
</html>